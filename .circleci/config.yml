# Use the latest 2.1 version of CircleCI pipeline process engine. 
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

## Orbs are reusable packages of CircleCI configuration that you may share across projects, enabling you to create encapsulated, parameterized commands, jobs, and executors that can be used across multiple projects.
orbs:
  android: circleci/android@1.0.3
  slack: circleci/slack@4.1

workflows:
  my-workflow:
    jobs:
      - build:
          context:
            - ga-field
            - docker-hub-creds
            - slack-secrets

jobs:
  # Below is the definition of your job to build and test your app, you can rename and customize it as you want.
  build:
    working_directory: ~/code
    docker:
      - image: circleci/android:api-29
        auth:
          username: bassga
          password: $DOCKERHUB_PASSWORD  # コンテキスト/プロジェクト UI 環境変数の参照
    environment:
      JVM_OPTS: -Xmx3200m
    steps:
      - checkout
      - restore_cache:
          key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}
      #      - run:
      #         name: Chmod パーミッション #Gradlew Dependencies のパーミッションが失敗する場合は、これを使用します
      #         command: sudo chmod +x ./gradlew
      - run:
          name: 依存関係のダウンロード
          command: ./gradlew androidDependencies
      - save_cache:
          paths:
            - ~/.gradle
          key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}
      - run:
          name: Lintテストの実行
          command: ./gradlew lint test
      - run:
          name: debugTest
          command: ./gradlew testDebug
      - store_artifacts: # アーティファクト (https://circleci.com/ja/docs/2.0/artifacts/) に表示されるようにします
          path: app/build/reports
          destination: reports
      - store_test_results: # テスト サマリー (https://circleci.com/ja/docs/2.0/collect-test-data/) に表示されるようにします
          path: app/build/test-results
      - slack/notify:
          channel: C01N14W0927
          event: pass
          template: basic_pass_1
      - slack/notify:
          channel: C01N14W0927
          event: fail
          template: basic_fail_1
      

      # デプロイの構成例は https://circleci.com/ja/docs/2.0/deployment-integrations/ を参照してください

#workflows:
#  # Below is the definition of your workflow.
#  # Inside the workflow, you provide the jobs you want to run, e.g this workflow runs the build-and-test job above.
#  # CircleCI will run this workflow on every commit.
#  # For more details on extending your workflow, see the configuration docs: https://circleci.com/docs/2.0/configuration-reference/#workflows
#  sample:
#    jobs:
#      - build-and-test
